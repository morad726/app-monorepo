"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[71214],{536612:(e,t,a)=>{a.d(t,{SX:()=>useAppUpdateInfo,sx:()=>useDownloadPackage,x7:()=>useAppChangeLog});var n=a(324586),r=a(586330),s=a(514041),o=a(908867),i=a(490343),l=a(604343),u=a(713132),d=a(254491),c=a(639451),p=a(757559),f=a(584186),g=a(60153),y=a(498356),h=a(911998);function ownKeys(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(a),!0).forEach((function(t){(0,n.A)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var useAppChangeLog=function(e){var t=(0,h.yk)((function(){return e?g.A.serviceAppUpdate.fetchChangeLog():Promise.resolve(null)}),[e]);return(0,s.useMemo)((function(){return t.result}),[t.result])},useDownloadPackage=function(){var e,t=(0,o.A)();return(0,s.useCallback)((e=(0,r.A)((function*(e){try{yield g.A.serviceAppUpdate.startDownloading();var a=yield(0,c.Xo)(e);yield g.A.serviceAppUpdate.verifyPackage(a),yield Promise.all([(0,c.sB)(a),f.A.wait(3e3)]),yield g.A.serviceAppUpdate.readyToInstall()}catch(e){i.Toast.error({title:t.formatMessage({id:d.ETranslations.global_update_failed})}),g.A.serviceAppUpdate.notifyFailed(e)}})),function(t){return e.apply(this,arguments)}),[t])},useAppUpdateInfo=function(e=!1){var t=(0,o.A)(),[a]=(0,l.useAppUpdatePersistAtom)(),n=(0,y.A)(),r=useDownloadPackage(),f=(0,s.useCallback)((function(){setTimeout((function(){(e?n.pushFullModal:n.pushModal)(p.ry.AppUpdateModal,{screen:p.mk.WhatsNew})}))}),[e,n.pushFullModal,n.pushModal]),h=(0,s.useCallback)((function(e=!1,t){(e?n.pushFullModal:n.pushModal)(p.ry.AppUpdateModal,{screen:p.mk.UpdatePreview,params:_objectSpread({latestVersion:a.latestVersion,isForceUpdate:a.isForceUpdate,autoClose:e},t)})}),[a.isForceUpdate,a.latestVersion,n.pushFullModal,n.pushModal]);(0,s.useEffect)((function(){(0,u.fK)(a)&&f(),a.status===u.ue.downloading&&r(a),g.A.serviceAppUpdate.fetchAppUpdateInfo().then((function(e){e?.isForceUpdate&&(0,u._q)(e.latestVersion,e.status)&&h(!0,e)}))}),[]);var b=(0,s.useCallback)((function(){switch(a.status){case u.ue.notify:case u.ue.downloading:case u.ue.verifying:h(e);break;case u.ue.ready:(0,c.Ed)(a).catch((function(e){i.Toast.error({title:t.formatMessage({id:d.ETranslations.global_update_failed})}),g.A.serviceAppUpdate.notifyFailed(e)}));break;case u.ue.failed:r(a)}}),[a,r,t,e,h]);return(0,s.useMemo)((function(){return{isNeedUpdate:(0,u._q)(a.latestVersion,a.status),data:a,onUpdateAction:b,toUpdatePreviewPage:h,onViewReleaseInfo:f}}),[a,b,f,h])}},331250:(e,t,a)=>{a.d(t,{l:()=>ViewUpdateHistory});var n=a(514041),r=a(908867),s=a(490343),o=a(254491),i=a(117746),l=a(831085);function ViewUpdateHistory(){var e=(0,r.A)(),t=(0,n.useCallback)((function(){(0,i.Dr)("https://github.com/OneKeyHQ/app-monorepo/releases")}),[]);return(0,l.jsx)(s.XStack,{children:(0,l.jsx)(s.Button,{mt:"$5",iconAfter:"ArrowTopRightOutline",onPress:t,size:"small",children:e.formatMessage({id:o.ETranslations.update_update_history})})})}},671214:(e,t,a)=>{a.r(t),a.d(t,{default:()=>h});var n=a(724249),r=a(908867),s=a(490343),o=a(254491),i=a(663522),l=a(536612),u=a(586330),d=a(514041),c=a(713132),p=a(639451),f=a(117746),g=a(831085),UpdatePreviewActionButton=function({autoClose:e}){var t=(0,r.A)(),a=(0,l.SX)(),n=(0,l.sx)(),i=(0,d.useCallback)((function(){}),[]),y=(0,d.useCallback)((function(){}),[]),h=(0,p.xf)(i,y),b=(0,d.useCallback)((function(t){a.data&&(a.data.storeUrl?(0,f.Dr)(a.data.storeUrl):a.data.downloadUrl&&(n(a.data),e&&t()))}),[a.data,e,n]),v=(0,d.useCallback)((0,u.A)((function*(){try{yield(0,p.Ed)(a.data)}catch(t){var{message:e}=t;e&&s.Toast.error({title:e})}})),[a.data]),A=[c.ue.downloading,c.ue.verifying].includes(a.data?.status),w=c.ue.ready===a.data?.status,m=(0,d.useCallback)((function(){switch(a.data?.status){case c.ue.downloading:return t.formatMessage({id:o.ETranslations.update_progress_downloading},{progress:h});case c.ue.verifying:return t.formatMessage({id:o.ETranslations.update_verifying});default:return t.formatMessage({id:o.ETranslations.update_update_now})}}),[a.data?.status,t,h]);return(0,g.jsx)(s.Page.Footer,{children:(0,g.jsx)(s.YStack,{children:(0,g.jsx)(s.Page.FooterActions,{confirmButtonProps:{disabled:A,loading:A},onConfirmText:m(),onConfirm:w?v:b})})})},y=a(331250),ExtPluginText=function(){return null};const h=function UpdatePreview({route:e}){var t=(0,r.A)(),{latestVersion:a,isForceUpdate:u,autoClose:d=!1}=e.params||{};(0,n.Fw)(!!u,(function(){}));var c=(0,l.x7)(a);return(0,g.jsxs)(s.Page,{children:[(0,g.jsx)(s.Page.Header,{title:t.formatMessage({id:o.ETranslations.update_app_update})}),(0,g.jsxs)(s.Page.Body,{m:"$5",children:[(0,g.jsxs)(s.YStack,{space:"$3",children:[(0,g.jsx)(s.Heading,{size:"$heading2xl",children:t.formatMessage({id:o.ETranslations.update_new_app_version})}),(0,g.jsx)(ExtPluginText,{}),(0,g.jsxs)(s.XStack,{space:"$2.5",alignItems:"center",children:[(0,g.jsx)(s.Badge,{badgeType:"default",badgeSize:"lg",children:i.Ay.version}),(0,g.jsx)(s.Icon,{name:"ArrowRightSolid",size:"$4"}),(0,g.jsx)(s.Badge,{badgeType:"info",badgeSize:"lg",children:a})]})]}),c?(0,g.jsxs)(s.ScrollView,{mt:"$7",contentInsetAdjustmentBehavior:"automatic",contentContainerStyle:{pb:"$5"},children:[(0,g.jsx)(s.Markdown,{children:c}),(0,g.jsx)(y.l,{})]}):null]}),(0,g.jsx)(UpdatePreviewActionButton,{autoClose:d})]})}},639451:(e,t,a)=>{a.d(t,{Ed:()=>u,Xo:()=>i,sB:()=>l,xf:()=>useDownloadProgress});var n,r,s,o=a(586330),i=(n=(0,o.A)((function*(){return{}})),function downloadPackage(){return n.apply(this,arguments)}),l=(r=(0,o.A)((function*(){})),function verifyPackage(){return r.apply(this,arguments)}),u=(s=(0,o.A)((function*(){})),function installPackage(){return s.apply(this,arguments)}),useDownloadProgress=function(){return 0}}}]);